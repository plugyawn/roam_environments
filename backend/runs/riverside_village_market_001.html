<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>riverside_village_market_001 · Scene Viewer</title>
    <style>
        :root {
            color-scheme: dark;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        body {
            margin: 0;
            background: #0f172a;
            color: #e2e8f0;
        }
        #app {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        #viewer {
            width: 100%;
            height: 100%;
        }
        #overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.78);
            border: 1px solid rgba(148, 163, 184, 0.35);
            backdrop-filter: blur(6px);
            max-width: 360px;
        }
        #overlay h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: 0.02em;
        }
        #overlay p.meta {
            margin: 6px 0 0;
            font-size: 13px;
            color: #94a3b8;
        }
        #overlay .stats {
            margin-top: 12px;
            font-size: 13px;
            line-height: 1.5;
            color: #cbd5f5;
        }
        #overlay button.control {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(30, 41, 59, 0.7);
            color: #e2e8f0;
            cursor: pointer;
        }
        #overlay button.control:hover {
            background: rgba(51, 65, 85, 0.9);
        }
        #status {
            margin-top: 12px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="viewer"></div>
        <div id="overlay">
            <h1>riverside_village_market_001</h1>
            <p class="meta">Generated 2025-10-29T03:01:01.847121Z</p>
            <div class="stats">
                <div><strong>Placements:</strong> 18</div>
                <div><strong>Assets:</strong> 14</div>
            </div>
            <details style="margin-top:12px;">
    <summary style="cursor:pointer; color:#e2e8f0;">Prompt</summary>
    <p style="margin:8px 0 0; font-size:13px; line-height:1.45; color:#cbd5f5;">Design a pastoral riverside village with a market square</p>
</details>
            <button id="resetCam" class="control" type="button">Reset Camera</button>
            <div id="status"></div>
        </div>
    </div>
    <script type="module">
    const VIEW_MODEL = {
  "sceneId": "riverside_village_market_001",
  "prompt": "Design a pastoral riverside village with a market square",
  "placements": [
    {
      "ref": "asset_001",
      "assetId": "asset_001",
      "concept": "asset",
      "position": [
        60.0,
        0.0,
        170.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_002",
      "assetId": "asset_002",
      "concept": "asset",
      "position": [
        75.0,
        0.0,
        150.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_003",
      "assetId": "asset_003",
      "concept": "asset",
      "position": [
        30.0,
        0.0,
        200.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 1.57,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 89.954,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_004",
      "assetId": "asset_004",
      "concept": "asset",
      "position": [
        30.0,
        0.0,
        230.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 1.57,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 89.954,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_005",
      "assetId": "asset_005",
      "concept": "asset",
      "position": [
        65.0,
        0.0,
        145.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_005",
      "assetId": "asset_005",
      "concept": "asset",
      "position": [
        85.0,
        0.0,
        145.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_005",
      "assetId": "asset_005",
      "concept": "asset",
      "position": [
        65.0,
        0.0,
        155.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_005",
      "assetId": "asset_005",
      "concept": "asset",
      "position": [
        85.0,
        0.0,
        155.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_006",
      "assetId": "asset_006",
      "concept": "asset",
      "position": [
        90.0,
        0.0,
        170.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_007",
      "assetId": "asset_007",
      "concept": "asset",
      "position": [
        45.0,
        0.0,
        120.0
      ],
      "rotation": {
        "x": 0.0,
        "y": -1.57,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": -89.954,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_008",
      "assetId": "asset_008",
      "concept": "asset",
      "position": [
        30.0,
        0.0,
        100.0
      ],
      "rotation": {
        "x": 0.0,
        "y": -1.57,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": -89.954,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_009",
      "assetId": "asset_009",
      "concept": "asset",
      "position": [
        75.0,
        0.0,
        150.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 1.57,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 89.954,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_010",
      "assetId": "asset_010",
      "concept": "asset",
      "position": [
        100.0,
        0.0,
        130.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 1.57,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 89.954,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_011",
      "assetId": "asset_011",
      "concept": "asset",
      "position": [
        105.0,
        0.0,
        135.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 1.57,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 89.954,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_012",
      "assetId": "asset_012",
      "concept": "asset",
      "position": [
        120.0,
        0.0,
        200.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 3.14,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 179.909,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_013",
      "assetId": "asset_013",
      "concept": "asset",
      "position": [
        5.0,
        0.0,
        150.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_014",
      "assetId": "asset_014",
      "concept": "asset",
      "position": [
        55.0,
        0.0,
        150.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    },
    {
      "ref": "asset_014",
      "assetId": "asset_014",
      "concept": "asset",
      "position": [
        95.0,
        0.0,
        150.0
      ],
      "rotation": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "rotationDegrees": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "scale": [
        1.0,
        1.0,
        1.0
      ]
    }
  ],
  "assets": {
    "asset_001": {
      "id": "asset_001",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_001"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_002": {
      "id": "asset_002",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_002"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_003": {
      "id": "asset_003",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_003"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_004": {
      "id": "asset_004",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_004"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_005": {
      "id": "asset_005",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_005"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_006": {
      "id": "asset_006",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_006"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_007": {
      "id": "asset_007",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_007"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_008": {
      "id": "asset_008",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_008"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_009": {
      "id": "asset_009",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_009"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_010": {
      "id": "asset_010",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_010"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_011": {
      "id": "asset_011",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_011"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_012": {
      "id": "asset_012",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_012"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_013": {
      "id": "asset_013",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_013"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    },
    "asset_014": {
      "id": "asset_014",
      "recipe": [
        {
          "primitive": "cuboid",
          "name": "asset",
          "w": 1.0,
          "h": 1.0,
          "d": 1.0
        }
      ],
      "materials": {
        "asset": "default_grey"
      },
      "tags": [
        "asset",
        "asset_014"
      ],
      "bbox": [
        1.0,
        1.0,
        1.0
      ]
    }
  },
  "materialPalette": {
    "default_grey": "#d1d5db",
    "plaster_white": "#f8fafc",
    "terracotta_red": "#b45309",
    "stone_gray": "#94a3b8",
    "timber_brown": "#b97944",
    "leaf_green": "#22c55e",
    "bark_brown": "#92400e",
    "water_blue": "#3b82f6",
    "copper_green": "#2dd4bf",
    "thatched_straw": "#facc15",
    "brick_red": "#ef4444",
    "slate_blue": "#6366f1",
    "sandstone": "#fcd34d",
    "dark_roof": "#1e293b",
    "grass_green": "#15803d",
    "dirt_brown": "#78350f",
    "metal_grey": "#64748b"
  },
  "generatedAt": "2025-10-29T03:01:01.847121Z"
};
const FALLBACK_COLORS = ["#f472b6", "#a855f7", "#38bdf8", "#14b8a6", "#34d399", "#f59e0b", "#f97316", "#ef4444"];

const CDN_SOURCES = [
    "https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js",
    "https://unpkg.com/three@0.160.1/build/three.module.js"
];

const statusElement = document.getElementById("status");

function setStatus(message, isError = false) {
    if (!statusElement) return;
    statusElement.textContent = message || "";
    statusElement.style.color = isError ? "#f87171" : "#94a3b8";
}

function toRadians(value) {
    if (!Number.isFinite(value)) return 0;
    return Math.abs(value) > Math.PI ? (value * Math.PI) / 180 : value;
}

function normalizeArray(value, length, fallback) {
    const result = new Array(length).fill(fallback);
    if (Array.isArray(value)) {
        value.slice(0, length).forEach((entry, index) => {
            const numeric = Number(entry);
            result[index] = Number.isFinite(numeric) ? numeric : fallback;
        });
    } else if (Number.isFinite(Number(value))) {
        const numeric = Number(value);
        result.fill(numeric);
    }
    return result;
}

function normalizeRotation(rotation) {
    if (!rotation) {
        return { x: 0, y: 0, z: 0 };
    }
    if (Array.isArray(rotation)) {
        const values = normalizeArray(rotation, 3, 0);
        return { x: toRadians(values[0]), y: toRadians(values[1]), z: toRadians(values[2]) };
    }
    if (typeof rotation === "object") {
        return {
            x: toRadians(Number(rotation.x) || 0),
            y: toRadians(Number(rotation.y) || 0),
            z: toRadians(Number(rotation.z) || 0)
        };
    }
    const value = toRadians(Number(rotation) || 0);
    return { x: 0, y: value, z: 0 };
}

function fallbackColor(seed) {
    let hash = 0;
    const text = String(seed || "material");
    for (let index = 0; index < text.length; index += 1) {
        hash = (hash * 31 + text.charCodeAt(index)) >>> 0;
    }
    return FALLBACK_COLORS[hash % FALLBACK_COLORS.length] || "#94a3b8";
}

function colorFromMaterial(materialName) {
    const palette = VIEW_MODEL.materialPalette || {};
    const key = String(materialName || "").toLowerCase();
    return palette[key] || fallbackColor(key);
}

function buildPrimitiveMesh(THREE, primitive, materials, fallback) {
    if (!primitive || typeof primitive !== "object") {
        return null;
    }
    const type = String(primitive.primitive || primitive.type || "cuboid").toLowerCase();
    let geometry;
    if (type === "plane") {
        const width = Number(primitive.w ?? primitive.width ?? 20) || 20;
        const depth = Number(primitive.d ?? primitive.depth ?? width) || width;
        geometry = new THREE.PlaneGeometry(Math.max(width, 0.1), Math.max(depth, 0.1));
    } else if (type === "cylinder") {
        const radius = Number(primitive.r ?? primitive.radius ?? 1) || 1;
        const height = Number(primitive.h ?? primitive.height ?? 1) || 1;
        const radiusTop = Number(primitive.radiusTop ?? radius) || radius;
        const radiusBottom = Number(primitive.radiusBottom ?? radius) || radius;
        const segments = Math.max(12, Number(primitive.segments ?? primitive.radialSegments ?? 24) || 24);
        geometry = new THREE.CylinderGeometry(radiusTop, radiusBottom, height, segments);
    } else if (type === "sphere") {
        const radius = Number(primitive.r ?? primitive.radius ?? 1) || 1;
        geometry = new THREE.SphereGeometry(radius, 24, 16);
    } else if (type === "pyramid") {
        const width = Number(primitive.w ?? primitive.width ?? 4) || 4;
        const depth = Number(primitive.d ?? primitive.depth ?? width) || width;
        const height = Number(primitive.h ?? primitive.height ?? 3) || 3;
        const radius = Math.max(width, depth) / 2;
        geometry = new THREE.ConeGeometry(Math.max(radius, 0.1), Math.max(height, 0.1), 4);
    } else {
        const width = Number(primitive.w ?? primitive.width ?? 4) || 4;
        const height = Number(primitive.h ?? primitive.height ?? 4) || 4;
        const depth = Number(primitive.d ?? primitive.depth ?? width) || width;
        geometry = new THREE.BoxGeometry(Math.max(width, 0.1), Math.max(height, 0.1), Math.max(depth, 0.1));
    }

    const materialName =
        primitive.material ||
        (primitive.name && materials[primitive.name]) ||
        materials[type] ||
        fallback ||
        primitive.name;

    const colorHex = primitive.color || colorFromMaterial(materialName);
    const material = new THREE.MeshStandardMaterial({
        color: new THREE.Color(colorHex),
        metalness: 0.1,
        roughness: 0.75
    });

    const mesh = new THREE.Mesh(geometry, material);
    mesh.castShadow = true;
    mesh.receiveShadow = type === "plane";

    const offset = normalizeArray(primitive.offset || primitive.position || [0, 0, 0], 3, 0);
    mesh.position.set(offset[0], offset[1], offset[2]);

    if (type === "plane") {
        mesh.rotation.x = -Math.PI / 2;
    }

    if (primitive.rotation) {
        const rotation = normalizeRotation(primitive.rotation);
        mesh.rotation.x += rotation.x;
        mesh.rotation.y += rotation.y;
        mesh.rotation.z += rotation.z;
    }

    if (primitive.scale) {
        const scale = normalizeArray(primitive.scale, 3, 1);
        mesh.scale.set(scale[0], scale[1], scale[2]);
    }

    return mesh;
}

function buildPlacementGroup(THREE, placement, assetIndex) {
    const group = new THREE.Group();
    const asset = assetIndex[placement.assetId] || assetIndex[placement.ref];
    const materials = (asset && asset.materials) || {};
    let hasChildren = false;

    if (asset && Array.isArray(asset.recipe)) {
        for (const primitive of asset.recipe) {
            const mesh = buildPrimitiveMesh(THREE, primitive, materials, placement.concept);
            if (mesh) {
                group.add(mesh);
                hasChildren = true;
            }
        }
    }

    if (!hasChildren) {
        const fallbackMesh = buildPrimitiveMesh(
            THREE,
            { primitive: "cuboid", w: 6, h: 6, d: 6 },
            {},
            placement.concept || placement.ref || placement.assetId
        );
        if (fallbackMesh) {
            group.add(fallbackMesh);
            hasChildren = true;
        }
    }

    if (!hasChildren) {
        return null;
    }

    const bbox = new THREE.Box3().setFromObject(group);
    if (Number.isFinite(bbox.min.y) && Math.abs(bbox.min.y) > 1e-3) {
        group.children.forEach((child) => {
            child.position.y -= bbox.min.y;
        });
    }

    const position = normalizeArray(placement.position, 3, 0);
    group.position.set(position[0], position[1], position[2]);

    const rotation = placement.rotation || {};
    group.rotation.set(
        Number(rotation.x) || 0,
        Number(rotation.y) || 0,
        Number(rotation.z) || 0
    );

    const scale = normalizeArray(placement.scale, 3, 1);
    group.scale.set(scale[0], scale[1], scale[2]);

    group.userData.placement = placement;
    return group;
}

function createOrbitController(THREE, camera, domElement) {
    const target = new THREE.Vector3();
    const spherical = new THREE.Spherical();
    const pointer = new THREE.Vector2();
    const defaultState = { target: target.clone(), theta: 0, phi: 0, radius: 150 };
    let dragging = false;

    domElement.style.touchAction = "none";
    domElement.style.cursor = "grab";

    function syncFromCamera() {
        const offset = camera.position.clone().sub(target);
        spherical.setFromVector3(offset);
    }

    function apply() {
        const offset = new THREE.Vector3().setFromSpherical(spherical);
        camera.position.copy(offset.add(target));
        camera.lookAt(target);
    }

    function update() {
        apply();
    }

    function onPointerDown(event) {
        dragging = true;
        pointer.set(event.clientX, event.clientY);
        domElement.style.cursor = "grabbing";
    }

    function onPointerMove(event) {
        if (!dragging) return;
        const deltaX = event.clientX - pointer.x;
        const deltaY = event.clientY - pointer.y;
        const ROTATE_SPEED = 0.0025;
        spherical.theta -= deltaX * ROTATE_SPEED;
        spherical.phi -= deltaY * ROTATE_SPEED;
        const EPS = 0.05;
        spherical.phi = Math.max(EPS, Math.min(Math.PI - EPS, spherical.phi));
        apply();
        pointer.set(event.clientX, event.clientY);
    }

    function onPointerUp() {
        dragging = false;
        domElement.style.cursor = "grab";
    }

    function onWheel(event) {
        event.preventDefault();
        const scale = Math.pow(0.95, event.deltaY * 0.01);
        const minRadius = 10;
        const maxRadius = 4000;
        spherical.radius = Math.max(minRadius, Math.min(maxRadius, spherical.radius * scale));
        apply();
    }

    domElement.addEventListener("pointerdown", onPointerDown);
    window.addEventListener("pointermove", onPointerMove);
    window.addEventListener("pointerup", onPointerUp);
    domElement.addEventListener("wheel", onWheel, { passive: false });

    syncFromCamera();
    apply();

    function setTarget(x, y, z) {
        target.set(x, y, z);
        syncFromCamera();
        apply();
    }

    function setRadius(value) {
        spherical.radius = Math.max(10, Math.min(4000, value));
        apply();
    }

    function setAngles(theta, phi) {
        spherical.theta = theta;
        spherical.phi = Math.max(0.05, Math.min(Math.PI - 0.05, phi));
        apply();
    }

    function saveState() {
        defaultState.target.copy(target);
        defaultState.theta = spherical.theta;
        defaultState.phi = spherical.phi;
        defaultState.radius = spherical.radius;
    }

    function reset() {
        target.copy(defaultState.target);
        spherical.theta = defaultState.theta;
        spherical.phi = defaultState.phi;
        spherical.radius = defaultState.radius;
        apply();
    }

    function dispose() {
        domElement.removeEventListener("pointerdown", onPointerDown);
        window.removeEventListener("pointermove", onPointerMove);
        window.removeEventListener("pointerup", onPointerUp);
        domElement.removeEventListener("wheel", onWheel);
    }

    return {
        target,
        update,
        setTarget,
        setRadius,
        setAngles,
        saveState,
        reset,
        dispose
    };
}

async function loadThree() {
    let lastError = null;
    for (const url of CDN_SOURCES) {
        try {
            const module = await import(url);
            if (module) {
                return module;
            }
        } catch (error) {
            lastError = error;
            console.warn("Failed to load", url, error);
        }
    }
    throw lastError || new Error("Unable to load three.js from CDN.");
}

async function bootstrap() {
    const container = document.getElementById("viewer");
    if (!container) {
        throw new Error("Viewer container missing.");
    }

    setStatus("Loading renderer…");
    const THREE = await loadThree();

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    if ("outputColorSpace" in renderer && THREE.SRGBColorSpace) {
        renderer.outputColorSpace = THREE.SRGBColorSpace;
    } else if ("outputEncoding" in renderer && THREE.sRGBEncoding) {
        renderer.outputEncoding = THREE.sRGBEncoding;
    }
    if ("toneMapping" in renderer && THREE.ACESFilmicToneMapping) {
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.05;
    }
    renderer.shadowMap.enabled = true;
    renderer.setPixelRatio(window.devicePixelRatio || 1);

    const width = container.clientWidth || window.innerWidth;
    const height = container.clientHeight || window.innerHeight;
    renderer.setSize(width, height);
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color("#0f172a");
    scene.fog = new THREE.FogExp2("#0f172a", 0.002);

    const camera = new THREE.PerspectiveCamera(55, width / Math.max(height, 1), 0.1, 5000);
    camera.position.set(120, 120, 120);

    const controls = createOrbitController(THREE, camera, renderer.domElement);

    const ambient = new THREE.HemisphereLight(0xdbeafe, 0x0f172a, 0.6);
    scene.add(ambient);
    const directional = new THREE.DirectionalLight(0xffffff, 0.85);
    directional.position.set(240, 360, 240);
    directional.castShadow = true;
    directional.shadow.mapSize.set(2048, 2048);
    directional.shadow.camera.near = 1;
    directional.shadow.camera.far = 1200;
    directional.shadow.camera.left = -400;
    directional.shadow.camera.right = 400;
    directional.shadow.camera.top = 400;
    directional.shadow.camera.bottom = -400;
    scene.add(directional);

    const grid = new THREE.GridHelper(800, 32, 0x1e293b, 0x334155);
    grid.position.y = 0;
    scene.add(grid);

    const placements = Array.isArray(VIEW_MODEL.placements) ? VIEW_MODEL.placements : [];
    const assetIndex = VIEW_MODEL.assets || {};
    const bounds = new THREE.Box3();

    placements.forEach((placement) => {
        const group = buildPlacementGroup(THREE, placement, assetIndex);
        if (!group) {
            return;
        }
        scene.add(group);
        group.updateMatrixWorld(true);
        bounds.expandByObject(group);
    });

    if (placements.length === 0 || bounds.isEmpty()) {
        bounds.setFromCenterAndSize(new THREE.Vector3(0, 0, 0), new THREE.Vector3(200, 80, 200));
    }

    const center = bounds.getCenter(new THREE.Vector3());
    const size = bounds.getSize(new THREE.Vector3());
    const radius = Math.max(size.x, size.y, size.z, 60);

    camera.position.set(center.x + radius * 1.2, center.y + radius * 0.8 + 60, center.z + radius * 1.2);
    controls.setTarget(center.x, Math.max(center.y, 0) + 5, center.z);
    controls.setRadius(Math.max(radius * 1.4, 80));
    controls.saveState();

    const resetButton = document.getElementById("resetCam");
    if (resetButton) {
        resetButton.addEventListener("click", () => {
            controls.reset();
        });
    }

    function handleResize() {
        const newWidth = container.clientWidth || window.innerWidth;
        const newHeight = container.clientHeight || window.innerHeight;
        renderer.setSize(newWidth, newHeight);
        camera.aspect = newWidth / Math.max(newHeight, 1);
        camera.updateProjectionMatrix();
    }

    window.addEventListener("resize", handleResize);

    setStatus("");

    function render() {
        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(render);
    }

    render();
}

bootstrap().catch((error) => {
    console.error(error);
    setStatus("Failed to initialize viewer.", true);
});
    </script>
</body>
</html>